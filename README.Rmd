---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# dtms - An R package for discrete-time multistate models

<!-- badges: start -->
<!-- badges: end -->

## Authors

Christian Dudel, dudel@demogr.mpg.de

Peng Li, li@demogr.mpg.de 

## Overview

The package dtms is a user-friendly implementation of discrete-time multistate
models in R. It comes with many tools to analyze the results of multistate 
models. In particular, the workflow mainly consists of estimating a 
discrete-time multistate model and then applying methods for absorbing Markov
chains. Discrete-time multistate models lend themselves well for modelling 
trajectories captured in panel data. 

## Disclaimer

This package is still undergoing development and many functions are still 
experimental. The content of this repository will likely change in the future, 
and functions and features might be added or removed without warning.

## Installation

You can install the development version of dtms like this:

``` r
library(devtools)
install_github("christiandudel/dtms")
```

## Example 1: Artificial data

This is a basic example using artificial data which is provided with the 
package. The state space consists of two transient states (A, B), and one 
absorbing state (X). The time scale goes from 0 to 20. Transition probabilities 
do change depending on time. 

The following code loads the package and the data set. The data set is called 
'simpledata'.
```{r example1-data}
## Load package 
library(dtms)

## Look at data
head(simpledata)

## Number of units
simpledata$id |> unique() |> length()

## Number of observations
dim(simpledata)
```
The data set is in long format and contains three variables. 'id' is an unit 
identifier; 'time' contains the value of the time scale; and 'state' contains 
the state the unit occupied at a given time. In total, there are 993 units, 
each of them contributing to the total of 12,173 observations. 

To work with this data set, we first define a basic discrete-time multistate 
model. This is done with the function 'dtms' and requires us to specify the
names of the transient states, the names of the absorbing states, and the 
possible values of the time scale: 
```{r example1-modeldef}
## Define model: Absorbing and transient states, time scale
simple <- dtms(transient=c("A","B"),
               absorbing="X",
               timescale=0:20)
```
The resulting object of class 'dtms' can be passed to other functions of the 
package, as shown 
below.

In a second step, we transform the data from long format to what we call 
transition format. This can be done using the function 'dtms_format'. In this 
example, we need to specify the name of the object containing the data, and
in addition a 'dtms' object as created above. Moreover, we need to specify which
variables contain the unit identifier, which variable contains the values of 
the time scale, and which variable contains the information on the state:
```{r example1-transformat}
## Reshape to transition format
estdata <- dtms_format(data=simpledata,
                       dtms=simple,
                       idvar="id",
                       timevar="time",
                       statevar="state")

## Look at reshaped data
head(estdata)
```
While in long format each row contains information on the currently occupied
state, in transition format also the next state is shown in a variable. If there
is no observation at time t+1, the next state is NA. The names of the variables 
in the resulting data set are by default chosen such that they match defaults of 
other functions of the package. 

Depending on the original data, there can be missing values in transition format
data due to several reasons. The function 'dtms_clean' provides a convenient
way to remove such rows in the data, as well as other potentially problematic
or unwanted rows. It returns a cleaned data set and prints a brief overview
of the dropped rows to the console:
```{r example1-cleaning}
## Missing values?
estdata$to |> table(useNA="always")

## Clean
estdata <- dtms_clean(data=estdata,
                      dtms=simple)
```
In this example, 1,260 transitions were dropped because they end in a missing
value. No observations were dropped because they are out of the time range 
specified with the 'dtms' object, and no observations were dropped because they
start in an absorbing state.

To estimate the transition probabilities of the multistate model, the function 
'dtms_fit' is used. In this simple example, it is enough to specify the name
of the object with the transition data:
```{r example1-fit}
# Fit model 
fit <- dtms_fit(data=estdata)
```
To predict transition probabilities and to arrange them in a matrix, the 
functions 'dtms_transitions' and 'dtms_matrix' are used. The function 
'dtms_transitions' needs a 'dtms' object as well as a fitted model, while
the function 'dtms_matrix' requires a 'dtms' object and predicted probabilities: 
```{r example1-probs}
## Predict probabilities
probs    <- dtms_transitions(dtms=simple,
                             model = fit)

## Get transition matrix 
Tp <- dtms_matrix(dtms=simple,
                  probs=probs)
```
In more complex examples, the previous functions would need more information. 
For instance, on which covariates to include in the estimation step, and which
covariate values to use in the prediction step.


```{r example1-start}
## Get starting distribution 
S <- dtms_start(dtms=simple,
                data=estdata)
```

```{r example1-results}
## State expectancies 
dtms_expectancy(dtms=simple,
                matrix=Tp,
                start_distr=S)

## Lifetime risk 
dtms_risk(dtms=simple,
          matrix=Tp,
          risk="A")

## Distribution of visits
dtms_visits(dtms=simple,
            matrix=Tp,
            risk="A",
            start_distr=S)

## First/last visit
dtms_first(dtms=simple,
           matrix=Tp,
           risk="A",
           start_distr=S)

dtms_last(dtms=simple,
          matrix=Tp,
          risk="A",
          start_distr=S,
          rescale=T,
          total=F)
```


## Example 2: Simulated HRS data

Here we provide an example based on simulated data from the Health and Retirement Study (HRS). There
are three transient states (employed, inactive or unemployed, retired) and one absorbing state (dead).

```{r example2}
## Load package
library(dtms)

## Define model: Absorbing and transient states, time scale
hrs <- dtms(transient=c("Employed","Inactive","Retired"),
            absorbing="Dead",
            timescale=50:99)

## Quick look at data
head(hrsdata)

## Reshape
estdata <- dtms_format(data=hrsdata,
                       dtms=hrs,
                       idvar="ID",
                       timevar="Age",
                       statevar="State")

## Drop dead-to-dead transitions etc
estdata <- dtms_clean(data=estdata,
                      dtms=hrs)

## Add age squared
estdata$time2 <- estdata$time^2
  
## Fit model
fit <- dtms_fit(data=estdata,
                controls=c("Gender","time2"))

## Transition probabilities by gender
  
# Men
probs_m <- dtms_transitions(dtms=hrs,
                             model = fit,
                             constant = list(Gender=0),
                             varying = list(time2 = (50:98)^2))
  
# Women
probs_w <- dtms_transitions(dtms=hrs,
                            model = fit,
                            constant = list(Gender=1),
                            varying = list(time2 = (50:98)^2))
 
## Transition matrices
Tm <- dtms_matrix(dtms=hrs,
                  probs=probs_m)
  
Tw <- dtms_matrix(dtms=hrs,
                  probs=probs_w)

## Starting distributions
Sm <- dtms_start(dtms=hrs,
                 data=estdata,
                 variables=list(Gender=0))
  
Sw <- dtms_start(dtms=hrs,
                 data=estdata,
                 variables=list(Gender=1))
  
## State expectancies
dtms_expectancy(dtms=hrs,
                matrix=Tm,
                start_distr=Sm)
    
dtms_expectancy(dtms=hrs,
                matrix=Tw,
                start_distr=Sw)

## A variant: ignoring retirement as a starting state (shown only for men)
limited <- c("Employed","Inactive")

Smwr <- dtms_start(dtms=hrs,
                   data=estdata,
                   start_state=limited,
                   variables=list(Gender=0))

dtms_expectancy(dtms=hrs,
                matrix=Tm,
                start_state=limited,
                start_distr=Smwr)

## Lifetime risk of reaching retirement
dtms_risk(dtms=hrs,
          matrix=Tm,
          risk="Retired",
          start_distr=Sm)
  
dtms_risk(dtms=hrs,
          matrix=Tw,
          risk="Retired",
          start_distr=Sw)
  
## Distribution of visits
dtms_visits(dtms=hrs,
            matrix=Tm,
            risk="Retired",
            start_distr=Sm)
  
dtms_visits(dtms=hrs,
            matrix=Tw,
            risk="Retired",
            start_distr=Sw,
            method="end")
  
## First visit
dtms_first(dtms=hrs,
           matrix=Tm,
           risk="Retired",
           start_distr=Sm)  
  
dtms_first(dtms=hrs,
           matrix=Tw,
           risk="Retired",
           start_distr=Sw)  

## Last exit
  
# Leaving employment to any state
dtms_last(dtms=hrs,
          matrix=Tm,
          risk="Employed",
          start_distr=Sm)  
  
dtms_last(dtms=hrs,
          matrix=Tw,
          risk="Employed",
          start_distr=Sw)  
  
# Leaving employment for retirement
dtms_last(dtms=hrs,
          matrix=Tm,
          risk="Employed",
          risk_to="Retired",
          start_distr=Sm)  
  
dtms_last(dtms=hrs,
          matrix=Tw,
          risk="Employed",
          risk_to="Retired",
          start_distr=Sw)  

```
