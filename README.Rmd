---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# dtms - An R package for discrete-time multistate models

<!-- badges: start -->
[![R-CMD-check](https://github.com/r-lib/usethis/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/r-lib/usethis/actions/workflows/R-CMD-check.yaml)
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
<!-- badges: end -->

## Authors

Christian Dudel, dudel@demogr.mpg.de

Peng Li, li@demogr.mpg.de 

## Overview

The package dtms is a user-friendly implementation of discrete-time multistate
models in R. It comes with many tools to analyze the results of multistate 
models. In particular, the workflow mainly consists of estimating a 
discrete-time multistate model and then applying methods for absorbing Markov
chains. Discrete-time multistate models lend themselves well for modelling 
trajectories captured in panel data. 

## Features

Data handling: functions for reshaping data, cleaning data, general descriptives
and descriptives on censoring. 

Estimation of transition probabilities: builds on existing R packages, allowing 
for semiparametric estimation ([VGAM](https://cran.r-project.org/web/packages/VGAM)), 
random effects and random intercepts ([mclogit](https://cran.r-project.org/web/packages/mclogit)), 
and neural networks ([nnet](https://cran.r-project.org/web/packages/nnet)). 
Functions for descriptive statistics on transition probabilities and for 
plotting them are also available.

Markov chain methods: (partial) state/life expectancy, (partial) lifetime risk, 
(partial) distribution of occupation time, (partial) distribution of waiting 
time to first visit, (partial) distribution of waiting time to last exit, 
Markov chains with rewards.

## Disclaimer

This package is currently undergoing development and many functions are 
experimental. The content of this repository will change in the future, and 
functions and features might be added or removed without warning.

## Installation

You can install the development version of dtms like this:

``` r
library(devtools)
install_github("christiandudel/dtms")
```

## Example 1: Artificial data

This is a basic example using artificial data which is provided with the 
package. The state space consists of two transient states (A, B), and one 
absorbing state (X). The time scale goes from 0 to 20. Transition probabilities 
do change depending on time. 

The following code loads the package and the data set. The data set is called 
'simpledata'.
```{r example1-data}
## Load package 
library(dtms)

## Look at data
head(simpledata)

## States
simpledata$state |> unique()

## Number of units
simpledata$id |> unique() |> length()

## Number of observations
dim(simpledata)
```
The data set is in long format and contains three variables. 'id' is an unit 
identifier; 'time' contains the value of the time scale; and 'state' contains 
the state the unit occupied at a given time. In total, there are 993 units, 
each of them contributing to the total of 12,173 observations. 

To work with this data set, we first define a basic discrete-time multistate 
model. This is done with the function 'dtms' and requires us to specify the
names of the transient states, the names of the absorbing states, and the 
possible values of the time scale: 
```{r example1-modeldef}
## Define model: Absorbing and transient states, time scale
simple <- dtms(transient=c("A","B"),
               absorbing="X",
               timescale=0:19)
```
The resulting object of class 'dtms' can be passed to other functions of the 
package, as shown below.

In a second step, we transform the data from long format to what we call 
transition format. This can be done using the function 'dtms_format'. In this 
example, we need to specify the name of the object containing the data, and
in addition a 'dtms' object as created above. Moreover, we need to specify which
variables contain the unit identifier, which variable contains the values of 
the time scale, and which variable contains the information on the state:
```{r example1-transformat}
## Reshape to transition format
estdata <- dtms_format(data=simpledata,
                       dtms=simple,
                       idvar="id",
                       timevar="time",
                       statevar="state")

## Look at reshaped data
head(estdata)
```
While in long format each row contains information on the currently occupied
state, in transition format also the next state is shown in a variable. If there
is no observation at time t+1, the next state is NA. The names of the variables 
in the resulting data set are by default chosen such that they match defaults of 
other functions of the package. 

Depending on the original data, there can be missing values in transition format
data due to several reasons. The function 'dtms_clean' provides a convenient
way to remove such rows in the data, as well as other potentially problematic
or unwanted rows. It returns a cleaned data set and prints a brief overview
of the dropped rows to the console:
```{r example1-cleaning}
## Missing values?
estdata$to |> table(useNA="always")

## Clean
estdata <- dtms_clean(data=estdata,
                      dtms=simple)
```
In this example, 1,260 transitions were dropped because they end in a missing
value. No observations were dropped because they are out of the time range 
specified with the 'dtms' object, and no observations were dropped because they
start in an absorbing state.

A brief overview of the data is provided when using the function 'summary':
```{r example1-summary}
## Summary of data
summary(estdata)
```
This shows for all possible transitions the absolute number each transition is
observed (e.g., there are 160 transitions from A to X); the proportion of 
each transition relative to all transitions (e.g., a bit more than 1% of all
observed transitions are from A to X); and raw transition probabilities (e.g.,
the probability of transitioning to X starting in A is around 4%).

Some more information on the data is provided by the function 'dtms_censoring'.
It can be used in different ways, but a basic version shows an overview of
the number of units with left censoring, the number of units with gaps in their
series of observations, and the number of units with right censoring:
```{r example1-censoring}
dtms_censoring(data=estdata,
               dtms=simple)
```

To estimate the transition probabilities of the multistate model, the function 
'dtms_fit' is used. In this simple example, it is enough to specify the name
of the object with the transition data:
```{r example1-fit}
## Fit model 
fit <- dtms_fit(data=estdata)
```
To predict transition probabilities and to arrange them in a matrix, the 
functions 'dtms_transitions' and 'dtms_matrix' are used. The function 
'dtms_transitions' needs a 'dtms' object as well as a fitted model, while
the function 'dtms_matrix' requires a 'dtms' object and predicted probabilities: 
```{r example1-probs}
## Predict probabilities
probs    <- dtms_transitions(dtms=simple,
                             model = fit)

## Get transition matrix 
Tp <- dtms_matrix(dtms=simple,
                  probs=probs)
```
In more complex examples, the previous functions would need more information. 
For instance, on which covariates to include in the estimation step, and which
covariate values to use in the prediction step. To get an overview of the
transition probabilities, the function summary can be used:
```{r example1-probsctd}
## Summary of probabilities
summary(probs)
```
For all combinations of starting and receiving state, this shows the lowest 
transition probability and at what value of the time scale it occurs. It also
shows the same for the highest transition probability, and in addition it shows
the median and the mean of all transition probabilities between two states.

Another useful way to look at the transition probabilies is to plot them. To
make this easy, the package provides the function dtms_simplify which can 
be applied to an object created with dtms_transitions to make it easier to plot.
For instance, using ggplot2, a simple plot could look like this:
```{r example1-probsplot}
## Simple plot
library(ggplot2)
probs |>  dtms_simplify() |> 
          ggplot(aes(x=time,y=P,color=to)) + 
          geom_line() + 
          facet_wrap(~from)
```
A simpler way is available which builds on base-R and does not require ggplot2.
However, this creates less nice figures and is mainly intended as a very quick
way of checking results:
```{r example1-baseplot}
## Simple base plot
plot(probs)
```

Before we generate more results, we calculate the starting distribution of
the states; i.e., the distribution of states at the first value of the time
scale. 
```{r example1-start}
## Get starting distribution 
S <- dtms_start(dtms=simple,
                data=estdata)
```
This step is not necessary, but its result can be passed to several of
the functions used for calculating results, providing additional information.

Most functions used to calculate results need a transition matrix and a 'dtms'
object, and potentially further arguments. The two examples below calculate 
the expected time spent in a state (dtms_expectancy) and the lifetime risk of
ever reaching a state (dtms_risk). In the first case, the starting distribution
of states is passed to the function; this is optional. In the second case, one 
or several states need to be specified for which the lifetime risk os be
calculated:
```{r example1-results1}
## State expectancies 
dtms_expectancy(dtms=simple,
                matrix=Tp,
                start_distr=S)

## Lifetime risk 
dtms_risk(dtms=simple,
          matrix=Tp,
          risk="A")
```
The results of the call of 'dtms_expectancy' show the starting states in rows
and the states in which the time is spent as columns. For instance, around 5.05
time units are spent in state A when starting in state A at time 0. The last 
column shows the total time until absorbtion. The last row is shown because the
starting distribution was specified. It shows the average time spent in a state
irrespective of the starting state. That is, on average 4.93 time units are 
spent in state A, 8.88 time units are spent in state B, for a total of 13.81 
time units. 

The result of the call of 'dtms_risk' above is the lifetime risk of ever
reaching state A depending on the starting state. Obviously, when starting in 
state A at time 0, this risk amounts to 1. When starting in state B, the risk is
also very high and around 97%. 

It is also possible to calculate state expectancies conditional on values of
the time scale. For this, a single transient state has to be specified for 
which we want to know how long units spent in it:
```{r example1-results1var}
dtms_expectancy(dtms=simple,
                risk="A",
                matrix=Tp)
```
In the example aboce, we look at the time spent in state A. The results by row
now indicate the remaining life expectancy in state A starting from the state
in the row at a given time. For instance, if a unit is in state A at time 5,
an additional 3.51 time units will be spent in state A (as seen in row named 
"A", column named "5"). 

The function calls below are all similar in that they provide full distributions
as a result. Specifically, 'dtms_visits' calculates the distribution of the 
time spent in a state; the mean over this distribution is equal to the state 
expectancy as provided by 'dtms_expectancy', and the one minus the proportion of 
0 time units spent in a state is equal to the lifetime risk provided by 
'dtms_risk'. 'dtms_first' calculates the distribution of the waiting time
until a given state is reached for the first time, conditional on ever reaching
this state. 'dtms_last' calculates the distribution of the waiting time until
a state is left for the last time; i.e., there is no return back to this state.
```{r example1-results2}
## Distribution of visits
dtms_visits(dtms=simple,
            matrix=Tp,
            risk="A",
            start_distr=S)

## Distribution of waiting time to first visit
dtms_first(dtms=simple,
           matrix=Tp,
           risk="A",
           start_distr=S)

## Distribution of waiting time to last exit
dtms_last(dtms=simple,
          matrix=Tp,
          risk="A",
          start_distr=S,
          rescale=T,
          total=F)
```
The output from these functions tends to be difficult to read, and often 
results on the distribution are used to calculate other statistics. A small
set of such statistics can be generated using the function 'summary':
```{r example1-results2-ctd}
## Distribution of visits
example <- dtms_visits(dtms=simple,
                       matrix=Tp,
                       risk="A",
                       start_distr=S)
summary(example)
```
In the example above this returns, respectively, the average lifetime spent in
state A; the variance of the lifetime spent in state A; the standard deviation 
of the lifetime spent in state A; the median of the lifetime spent in state A;
 and the probability of spending zero lifetime in state A. Depending on which
 distribution this function is applied to, some entries might not be defined. 
 For instance: 
```{r example1-results2-ctd2}
## Distribution of waiting time to last exit
example2 <- dtms_last(dtms=simple,
                      matrix=Tp,
                      risk="A",
                      start_distr=S,
                      rescale=T,
                      total=F)
summary(example2)
```
In this case, the distribution is conditional on ever experiencing the exit
from state A, such that the waiting time until exit always has to be above 0. 

## Example 2: Working trajectories during late working life

Here we provide an example using simulated data based on the Health and 
Retirement Study (HRS). The simulations are are conducted using transition 
probabilities estimated from the HRS and published by Dudel & Myrskylä (2017) 
who studied working trajectories in late working life and old age. These
transition probabilities are used to simulate artificial but realistic 
trajectories. There are three transient states 
(employed, inactive or unemployed, retired) and one absorbing state (dead). 
The time scale represents age and ranges from 50 to 99, as the focus is on older
individuals. Note that the actual HRS data is collected every two years and 
while the simulated data is annual. The data set also contains each individual's 
gender, and the transition probabilities underlying the simulated trajectories 
differ between men and women.

The workflow is similar to the previous example. First, a 'dtms' model is 
defined using the function `dtms'. Second, the data is brought into 
transition format and cleaned. Third, transition probabilities are estimated
and put into a transition matrix. In this example, probabilities are estimated
and predicted using time-constant and time-varying covariates. Finally, the 
transition matrix is used to calculate state expectancies and similar measures. 

```{r example2}
## Load packages
library(dtms)
library(ggplot2)

## Define model: Absorbing and transient states, time scale
hrs <- dtms(transient=c("Employed","Inactive","Retired"),
            absorbing="Dead",
            timescale=50:99)

## Quick look at data
head(hrsdata)

## Reshape
estdata <- dtms_format(data=hrsdata,
                       dtms=hrs,
                       idvar="ID",
                       timevar="Age",
                       statevar="State")

## Drop dead-to-dead transitions etc
estdata <- dtms_clean(data=estdata,
                      dtms=hrs)

## Overview
summary(estdata)

## Basic censoring
dtms_censoring(data=estdata,
               dtms=hrs)

## More advanced censoring example
estdata <- dtms_censoring(data=estdata,
                          dtms=hrs,
                          add=T,
                          addtype="obs")

estdata |>
  subset(subset=to!="Dead",select=c(RIGHT,to)) |>
  table() |>
  prop.table(margin=1)

## Add age squared
estdata$time2 <- estdata$time^2
  
## Fit model
fit <- dtms_fit(data=estdata,
                controls=c("Gender","time2"))

## Transition probabilities by gender
  
# Men
probs_m <- dtms_transitions(dtms=hrs,
                             model = fit,
                             constant = list(Gender=0),
                             varying = list(time2 = (50:98)^2))
  
# Women
probs_w <- dtms_transitions(dtms=hrs,
                            model = fit,
                            constant = list(Gender=1),
                            varying = list(time2 = (50:98)^2))

# Overview
summary(probs_m)
summary(probs_w)

# Plotting, men as example
probs_m |>  dtms_simplify() |> 
            ggplot(aes(x=time,y=P,color=to)) + 
            geom_line() + 
            facet_wrap(~from)
 
## Transition matrices
Tm <- dtms_matrix(dtms=hrs,
                  probs=probs_m)
  
Tw <- dtms_matrix(dtms=hrs,
                  probs=probs_w)

## Starting distributions
Sm <- dtms_start(dtms=hrs,
                 data=estdata,
                 variables=list(Gender=0))
  
Sw <- dtms_start(dtms=hrs,
                 data=estdata,
                 variables=list(Gender=1))
  
## State expectancies
dtms_expectancy(dtms=hrs,
                matrix=Tm,
                start_distr=Sm)
    
dtms_expectancy(dtms=hrs,
                matrix=Tw,
                start_distr=Sw)

## A variant: ignoring retirement as a starting state (shown only for men)
limited <- c("Employed","Inactive")

Smwr <- dtms_start(dtms=hrs,
                   data=estdata,
                   start_state=limited,
                   variables=list(Gender=0))

dtms_expectancy(dtms=hrs,
                matrix=Tm,
                start_state=limited,
                start_distr=Smwr)

## Lifetime risk of reaching retirement
dtms_risk(dtms=hrs,
          matrix=Tm,
          risk="Retired",
          start_distr=Sm)
  
dtms_risk(dtms=hrs,
          matrix=Tw,
          risk="Retired",
          start_distr=Sw)
  
## Distribution of visits
visitsm <- dtms_visits(dtms=hrs,
                       matrix=Tm,
                       risk="Retired",
                       start_distr=Sm)
  
visitsw <- dtms_visits(dtms=hrs,
                       matrix=Tw,
                       risk="Retired",
                       start_distr=Sw,
                       method="end")

summary(visitsm)
summary(visitsw)
  
## First visit
firstm <- dtms_first(dtms=hrs,
                     matrix=Tm,
                     risk="Retired",
                     start_distr=Sm)  
  
firstw <- dtms_first(dtms=hrs,
                     matrix=Tw,
                     risk="Retired",
                     start_distr=Sw)  

summary(firstm)
summary(firstw)

## Last exit
  
# Leaving employment to any state
last1m <- dtms_last(dtms=hrs,
                    matrix=Tm,
                    risk="Employed",
                    start_distr=Sm)  
  
last1w <- dtms_last(dtms=hrs,
                    matrix=Tw,
                    risk="Employed",
                    start_distr=Sw) 

summary(last1m)
summary(last1w)
  
# Leaving employment for retirement
last2m <- dtms_last(dtms=hrs,
                    matrix=Tm,
                    risk="Employed",
                    risk_to="Retired",
                    start_distr=Sm)  
  
last2w <- dtms_last(dtms=hrs,
                    matrix=Tw,
                    risk="Employed",
                    risk_to="Retired",
                    start_distr=Sw)  

summary(last2m)
summary(last2w)

```
