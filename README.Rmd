---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# dtms - An R package for discrete-time multistate models

<!-- badges: start -->
<!-- badges: end -->

## Authors

Christian Dudel, dudel@demogr.mpg.de

Peng Li, li@demogr.mpg.de 

## Overview

The package dtms is a user-friendly implementation of discrete-time multistate models in R. It comes with many tools to analyze the results of multistate models. In particular, the worklfow mainly consists of estimating a discrete-time multistate model and then applying methods for absorbing Markov chains. Discrete-time multistate models lend themselves
well for modelling trajectories captured in panel data. 

## Disclaimer

This package is still undergoing development and many functions are still experimental. The 
content of this repository will likely change in the future, and functions and features 
might be added or removed without warning.

## Installation

You can install the development version of dtms like this:

``` r
library(devtools)
install_github("christiandudel/dtms")
```

## Example 1: Artificial data

This is a very basic example using artificial data provided with the package. The state space consists
of two transient states (A, B), and one absorbing state (X). The time scale goes from 0 to 20.
Transition probabilities do change depending on time. 

```{r example1}
## Load package
library(dtms)

## Define model: Absorbing and transient states, time scale
simple <- dtms(transient=c("A","B"),
               absorbing="X",
               timescale=0:20)

## Look at original data
head(simpledata)

## Reshape to transition format
estdata <- dtms_format(data=simpledata,
                       dtms=simple,
                       idvar="id",
                       timevar="time",
                       statevar="state")

## Look at reshaped data
head(estdata)

## Clean
estdata <- dtms_clean(data=estdata,
                      dtms=simple)

# Fit model 
fit <- dtms_fit(data=estdata)

## Predict probabilities
probs    <- dtms_transitions(dtms=simple,
                             model = fit)

## Get transition matrix 
Tp <- dtms_matrix(dtms=simple,
                  probs=probs)

## Get starting distribution 
S <- dtms_start(dtms=simple,
                data=estdata)

## State expectancies 
dtms_expectancy(dtms=simple,
                matrix=Tp,
                start_distr=S)

## Lifetime risk 
dtms_risk(dtms=simple,
          matrix=Tp,
          risk="A")

## Distribution of visits
dtms_visits(dtms=simple,
            matrix=Tp,
            risk="A",
            start_distr=S)

## First/last visit
dtms_first(dtms=simple,
           matrix=Tp,
           risk="A",
           start_distr=S)

dtms_last(dtms=simple,
          matrix=Tp,
          risk="A",
          start_distr=S,
          rescale=T,
          total=F)
```


## Example 2: Simulated HRS data

Here we provide an example based on simulated data from the Health and Retirement Study (HRS).

```{r example2}
## Load package
library(dtms)

## Define model: Absorbing and transient states, time scale
hrs <- dtms(transient=c("Employed","Inactive","Retired"),
            absorbing="Dead",
            timescale=50:99)

## Quick look at data
head(hrsdata)

## Reshape
estdata <- dtms_format(data=hrsdata,
                       dtms=hrs,
                       idvar="ID",
                       timevar="Age",
                       statevar="State")

## Drop dead-to-dead transitions etc
estdata <- dtms_clean(data=estdata,
                      dtms=hrs)

## Add age squared
estdata$time2 <- estdata$time^2
  
## Fit model
fit <- dtms_fit(data=estdata,
                controls=c("Gender","time2"))

## Transition probabilities by gender
  
# Men
probs_m <- dtms_transitions(dtms=hrs,
                             model = fit,
                             constant = list(Gender=0),
                             varying = list(time2 = (50:98)^2))
  
# Women
probs_w <- dtms_transitions(dtms=hrs,
                            model = fit,
                            constant = list(Gender=1),
                            varying = list(time2 = (50:98)^2))
 
## Transition matrices
Tm <- dtms_matrix(dtms=hrs,
                  probs=probs_m)
  
Tw <- dtms_matrix(dtms=hrs,
                  probs=probs_w)

## Starting distributions
Sm <- dtms_start(dtms=hrs,
                 data=estdata,
                 variables=list(Gender=0))
  
Sw <- dtms_start(dtms=hrs,
                 data=estdata,
                 variables=list(Gender=1))
  
## State expectancies
dtms_expectancy(dtms=hrs,
                matrix=Tm,
                start_distr=Sm)
    
dtms_expectancy(dtms=hrs,
                matrix=Tw,
                start_distr=Sw)

## Lifetime risk of reaching retirement
dtms_risk(dtms=hrs,
          matrix=Tm,
          risk="Retired",
          start_distr=Sm)
  
dtms_risk(dtms=hrs,
          matrix=Tw,
          risk="Retired",
          start_distr=Sw)
  
## Distribution of visits
dtms_visits(dtms=hrs,
            matrix=Tm,
            risk="Retired",
            start_distr=Sm)
  
dtms_visits(dtms=hrs,
            matrix=Tw,
            risk="Retired",
            start_distr=Sw,
            method="end")
  
## First visit
dtms_first(dtms=hrs,
           matrix=Tm,
           risk="Retired",
           start_distr=Sm)  
  
dtms_first(dtms=hrs,
           matrix=Tw,
           risk="Retired",
           start_distr=Sw)  

### Last exit
  
# Leaving employment to any state
dtms_last(dtms=hrs,
          matrix=Tm,
          risk="Employed",
          start_distr=Sm)  
  
dtms_last(dtms=hrs,
          matrix=Tw,
          risk="Employed",
          start_distr=Sw)  
  
# Leaving employment for retirement
dtms_last(dtms=hrs,
          matrix=Tm,
          risk="Employed",
          risk_to="Retired",
          start_distr=Sm)  
  
dtms_last(dtms=hrs,
          matrix=Tw,
          risk="Employed",
          risk_to="Retired",
          start_distr=Sw)  

```
